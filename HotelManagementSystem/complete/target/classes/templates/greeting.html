<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Core Flow — Hotel</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>

  <style>
    :root{
      /* Light palette */
      --bg:#f8fafc;           /* slate-50 */
      --bg2:#eef2ff;          /* indigo-50 */
      --surface:#ffffff;
      --border:#e2e8f0;       /* slate-200 */
      --brand:#7c3aed;        /* violet-600 */
      --brand-weak:#ede9fe;   /* violet-100 */
      --text:#0f172a;         /* slate-900 */
      --muted:#475569;        /* slate-600 */
      --head:#0b1324;
      --radius:16px;
      --shadow:0 10px 30px rgba(2,6,23,.08);
    }
    body{
      background:
        radial-gradient(1200px 600px at 20% -10%, var(--bg2), transparent),
        radial-gradient(1200px 800px at 120% 10%, #eaf2ff, transparent),
        var(--bg);
      color: var(--text);
    }
    .navbar{
      background: linear-gradient(90deg, #ffffffcc, #f8fafcdd);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .navbar .navbar-brand{ color: var(--head); }
    .card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    h5{ color: var(--head); }
    .pill{
      font-size:.75rem; padding:.25rem .6rem; border-radius:999px;
      background: var(--brand-weak); color: #4c1d95; /* violet-900 */
      border: 1px solid #ddd6fe;
    }
    .muted{ color: var(--muted); }

    .form-control, .form-select{
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .form-control:focus, .form-select:focus{
      border-color: #c4b5fd; /* violet-300 */
      box-shadow: 0 0 0 .2rem rgba(124,58,237,.15);
    }

    .btn-brand{
      background: linear-gradient(180deg, #7c3aed, #6d28d9);
      color: #fff; border: none; box-shadow: 0 6px 16px rgba(124,58,237,.25);
    }
    .btn-brand:hover{ filter: brightness(1.05); }
    .btn-soft{
      background: #f5f3ff; color: #5b21b6; border: 1px solid #ddd6fe;
    }
    .btn-soft:hover{ background:#ede9fe; }

    .btn-xs{ padding:.3rem .6rem; font-size:.82rem; border-radius:10px; }

    .table{ color: var(--text); }
    .table thead th{
      color:#334155; background:#f1f5f9; border-bottom: 1px solid var(--border);
    }
    .table tbody tr:hover{ background:#f8fafc; }
    .table td, .table th{ border-color: var(--border) !important; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">Hotel Dashboard</a>
    <span class="pill ms-auto">Core Flow: Tìm phòng → Đặt → Dịch vụ → Hoá đơn</span>
  </div>
</nav>

<div class="container my-4">
  <!-- Hàng 1: khối lớn trung tâm (TÌM PHÒNG + TẠO ĐẶT PHÒNG) -->
  <div class="row g-4">
    <div class="col-12">
      <div class="card p-3 p-md-4">
        <div class="d-flex align-items-center mb-3">
          <h5 class="mb-0">1) Tìm phòng trống</h5>
          <span class="ms-2 pill">/api/dat-phong/tim-phong-trong</span>
        </div>

        <div class="row g-3">
          <div class="col-6 col-md-3">
            <label class="form-label">Ngày nhận</label>
            <input id="nhan" type="date" class="form-control" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Ngày trả</label>
            <input id="tra" type="date" class="form-control" />
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Số khách</label>
            <input id="soNguoi" type="number" class="form-control" min="1" value="1"/>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Loại phòng (tuỳ chọn)</label>
            <select id="loaiPhong" class="form-select">
              <option value="">-- Bất kỳ --</option>
              <option value="STANDARD">STANDARD</option>
              <option value="DELUXE">DELUXE</option>
              <option value="SUITE">SUITE</option>
            </select>
          </div>
          <div class="col-12">
            <button class="btn btn-brand me-2" id="btnTim">Tìm phòng trống</button>
            <span class="muted">Dữ liệu lấy từ DB qua API.</span>
          </div>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead><tr>
              <th>Mã phòng</th><th>Tên</th><th>Loại</th><th>Sức chứa</th><th>Giá/đêm</th><th></th>
            </tr></thead>
            <tbody id="tblPhongTrong"><tr><td colspan="6" class="muted">Chưa có dữ liệu</td></tr></tbody>
          </table>
        </div>

        <hr class="my-4" style="opacity:.5; border-color: var(--border)">

        <div class="d-flex align-items-center mb-3">
          <h5 class="mb-0">2) Tạo đặt phòng</h5>
          <span class="ms-2 pill">/api/dat-phong</span>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-3">
            <label class="form-label">Mã đặt phòng</label>
            <div class="input-group">
              <input id="maDP" class="form-control" placeholder="VD: DP-20250812-0001">
              <button class="btn btn-soft btn-xs" id="btnGenMa">Tạo mã</button>
            </div>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Định danh KH (CCCD/Passport)</label>
            <input id="dinhDanhKhach" class="form-control" placeholder="VD: 0123456789">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Mã phòng</label>
            <input id="maPhong" class="form-control" placeholder="Chọn ở bảng trên hoặc nhập tay">
          </div>
          <div class="col-6 col-md-1">
            <label class="form-label">Số khách</label>
            <input id="soKhach" type="number" class="form-control" min="1" value="1">
          </div>
          <div class="col-6 col-md-2 d-flex align-items-end">
            <button class="btn btn-brand w-100" id="btnDatPhong">Tạo đặt phòng</button>
          </div>
        </div>

        <div class="mt-3">
          <div id="status" class="muted">Chưa có đặt phòng.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hàng 2: 2 khối nhỏ -->
  <div class="row g-4 mt-1">
    <!-- DỊCH VỤ -->
    <div class="col-12 col-lg-6">
      <div class="card p-3 p-md-4">
        <div class="d-flex align-items-center mb-3">
          <h5 class="mb-0">3) Thêm dịch vụ vào booking</h5>
          <span class="ms-2 pill">/api/ctdv/booking/{maDP}</span>
        </div>

        <div class="row g-3">
          <div class="col-7">
            <label class="form-label">Dịch vụ</label>
            <select id="selDichVu" class="form-select"></select>
          </div>
          <div class="col-3">
            <label class="form-label">Số lượng</label>
            <input id="soLuongDV" type="number" min="1" value="1" class="form-control">
          </div>
          <div class="col-2 d-flex align-items-end">
            <button class="btn btn-brand w-100" id="btnThemDV">Thêm</button>
          </div>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead><tr><th>ID</th><th>Mã DV</th><th>Số lượng</th><th>Thành tiền</th><th></th></tr></thead>
            <tbody id="tblCTDV"><tr><td colspan="5" class="muted">Chưa có dịch vụ</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- HOÁ ĐƠN -->
    <div class="col-12 col-lg-6">
      <div class="card p-3 p-md-4">
        <div class="d-flex align-items-center mb-3">
          <h5 class="mb-0">4) Xuất hoá đơn</h5>
          <span class="ms-2 pill">/api/hoa-don/from-booking</span>
        </div>

        <div class="row g-3">
          <div class="col-5">
            <label class="form-label">Giảm giá (VND)</label>
            <input id="giamGia" type="number" min="0" value="0" class="form-control">
          </div>
          <div class="col-5">
            <label class="form-label">Phương thức</label>
            <select id="phuongThuc" class="form-select">
              <option>TIEN_MAT</option>
              <option>THE</option>
              <option>CHUYEN_KHOAN</option>
              <option>VI_DIEN_TU</option>
            </select>
          </div>
          <div class="col-2 d-flex align-items-end">
            <button class="btn btn-brand w-100" id="btnXuatHD">Xuất</button>
          </div>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead><tr>
              <th>Mã HĐ</th><th>Tổng phòng</th><th>Tổng DV</th><th>Thuế</th><th>Giảm</th><th>Phải trả</th><th>Ngày TT</th>
            </tr></thead>
            <tbody id="tblHD"><tr><td colspan="7" class="muted">Chưa có hoá đơn</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1055">
  <div id="toast" class="toast text-bg-dark border-0" role="alert" data-bs-delay="2500">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">...</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ========= Helpers =========
  const $ = (s)=>document.querySelector(s);
  const toastEl = $('#toast'); const toast = new bootstrap.Toast(toastEl);
  function notify(msg){ $('#toastBody').textContent = msg; toast.show(); }

  const API = {
    timPhongTrong: (payload)=> fetch('/api/dat-phong/tim-phong-trong', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    }).then(r=>r.ok?r.json():r.text().then(t=>Promise.reject(t))),

    listDichVu: ()=> fetch('/api/dich-vu').then(r=>r.ok?r.json():[]),

    taoDatPhong: (dp)=> fetch('/api/dat-phong', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(dp)
    }).then(r=>r.ok?r.json():r.text().then(t=>Promise.reject(t))),

    listCTDV: (maDP)=> fetch(`/api/ctdv/booking/${encodeURIComponent(maDP)}`).then(r=>r.ok?r.json():[]),
    addCTDV: (maDP, body)=> fetch(`/api/ctdv/booking/${encodeURIComponent(maDP)}`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    }).then(r=>r.ok?r.json():r.text().then(t=>Promise.reject(t))),
    delCTDV: (id)=> fetch(`/api/ctdv/${id}`, { method:'DELETE' }).then(r=>r.ok?true:Promise.reject('Xoá thất bại')),

    xuatHoaDon: (body)=> fetch('/api/hoa-don/from-booking', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    }).then(r=>r.ok?r.json():r.text().then(t=>Promise.reject(t))),
    hdByBooking: (maDP)=> fetch(`/api/hoa-don/booking/${encodeURIComponent(maDP)}`).then(r=>r.ok?r.json():null)
  };

  // ========= State =========
  let currentDP = null; // { maDatPhong, ... }

  // ========= UI logic =========
  function renderPhongTrong(list){
    const tb = $('#tblPhongTrong');
    if(!list || list.length===0){
      tb.innerHTML = `<tr><td colspan="6" class="muted">Không có phòng trống phù hợp</td></tr>`;
      return;
    }
    tb.innerHTML = list.map(p=>`
      <tr>
        <td>${p.maPhong}</td>
        <td>${p.ten || '-'}</td>
        <td>${p.loai || '-'}</td>
        <td>${p.sucChua ?? '-'}</td>
        <td>${p.giaMoiDem?.toLocaleString('vi-VN') ?? '-'}</td>
        <td><button class="btn btn-soft btn-xs" onclick="chonPhong('${p.maPhong}')">Chọn</button></td>
      </tr>
    `).join('');
  }
  window.chonPhong = (ma)=>{ $('#maPhong').value = ma; notify('Đã chọn phòng ' + ma); };

  function renderCTDV(list){
    const tb = $('#tblCTDV');
    if(!list || list.length===0){
      tb.innerHTML = `<tr><td colspan="5" class="muted">Chưa có dịch vụ</td></tr>`;
      return;
    }
    tb.innerHTML = list.map(c=>`
      <tr>
        <td>${c.id}</td>
        <td>${c.maDichVu}</td>
        <td>${c.soLuong}</td>
        <td>${(c.thanhTien||0).toLocaleString('vi-VN')}</td>
        <td><button class="btn btn-outline-danger btn-xs" onclick="delCT(${c.id})">Xoá</button></td>
      </tr>
    `).join('');
  }
  window.delCT = async (id)=>{
    try{
      await API.delCTDV(id);
      notify('Đã xoá dịch vụ');
      if(currentDP) loadCTDV(currentDP.maDatPhong);
    }catch(e){ notify(e); }
  };

  function renderHD(hd){
    const tb = $('#tblHD');
    if(!hd){ tb.innerHTML = `<tr><td colspan="7" class="muted">Chưa có hoá đơn</td></tr>`; return; }
    tb.innerHTML = `
      <tr>
        <td>${hd.maHoaDon}</td>
        <td>${(hd.tongTienPhong||0).toLocaleString('vi-VN')}</td>
        <td>${(hd.tongTienDichVu||0).toLocaleString('vi-VN')}</td>
        <td>${(hd.thue||0).toLocaleString('vi-VN')}</td>
        <td>${(hd.giamGia||0).toLocaleString('vi-VN')}</td>
        <td><strong>${(hd.tongThanhToan||0).toLocaleString('vi-VN')}</strong></td>
        <td>${hd.ngayThanhToan || '-'}</td>
      </tr>
    `;
  }

  async function loadDichVu(){
    const list = await API.listDichVu().catch(()=>[]);
    const sel = $('#selDichVu');
    sel.innerHTML = (list||[]).map(d=>`<option value="${d.maDichVu}">${d.maDichVu} — ${d.ten} (${(d.gia||0).toLocaleString('vi-VN')})</option>`).join('');
  }
  async function loadCTDV(maDP){ const list = await API.listCTDV(maDP).catch(()=>[]); renderCTDV(list); }
  async function loadHD(maDP){ const hd = await API.hdByBooking(maDP).catch(()=>null); renderHD(hd); }

  // ========= Events =========
  $('#btnTim').addEventListener('click', async ()=>{
    const nhan = $('#nhan').value, tra = $('#tra').value;
    const soNguoi = parseInt($('#soNguoi').value || '1',10);
    const loaiPhong = $('#loaiPhong').value || null;
    if(!nhan || !tra){ notify('Vui lòng chọn ngày nhận/trả'); return; }
    if(new Date(tra) <= new Date(nhan)){ notify('Ngày trả phải sau ngày nhận'); return; }

    try{
      const list = await API.timPhongTrong({ ngayNhan: nhan, ngayTra: tra, soNguoi, loaiPhong });
      renderPhongTrong(list);
      notify('Đã tải danh sách phòng trống');
    }catch(e){ notify(e); }
  });

  $('#btnGenMa').addEventListener('click', ()=>{
    const r = Math.floor(Math.random()*1e6).toString().padStart(6,'0');
    const d = new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
    $('#maDP').value = `DP-${y}${m}${day}-${r}`;
  });

  $('#btnDatPhong').addEventListener('click', async ()=>{
    const maDatPhong = $('#maDP').value.trim();
    const dinhDanhKhach = $('#dinhDanhKhach').value.trim();
    const maPhong = $('#maPhong').value.trim();
    const soKhach = parseInt($('#soKhach').value || '1',10);
    const ngayNhan = $('#nhan').value, ngayTra = $('#tra').value;

    if(!maDatPhong || !dinhDanhKhach || !maPhong || !ngayNhan || !ngayTra){
      notify('Thiếu trường bắt buộc'); return;
    }
    /* FIX bug: dùng đúng biến ngày */
    if(new Date(ngayTra) <= new Date(ngayNhan)){
      notify('Ngày trả phải sau ngày nhận'); return;
    }

    try{
      const dp = await API.taoDatPhong({ maDatPhong, dinhDanhKhach, maPhong, ngayNhan, ngayTra, soKhach });
      currentDP = dp;
      $('#status').innerHTML = `Đã tạo đặt phòng <strong>${dp.maDatPhong}</strong> cho KH <strong>${dp.dinhDanhKhach}</strong> — trạng thái: <span class="pill">${dp.trangThai || 'DA_DAT'}</span>`;
      await loadCTDV(dp.maDatPhong);
      await loadHD(dp.maDatPhong);
      notify('Tạo đặt phòng thành công');
    }catch(e){ notify(e); }
  });

  $('#btnThemDV').addEventListener('click', async ()=>{
    if(!currentDP){ notify('Chưa có mã đặt phòng'); return; }
    const maDichVu = $('#selDichVu').value;
    const soLuong = parseInt($('#soLuongDV').value || '1',10);
    if(!maDichVu || soLuong<=0){ notify('Chọn dịch vụ và số lượng > 0'); return; }

    try{
      await API.addCTDV(currentDP.maDatPhong, { maDichVu, soLuong });
      await loadCTDV(currentDP.maDatPhong);
      await loadHD(currentDP.maDatPhong);
      notify('Đã thêm dịch vụ');
    }catch(e){ notify(e); }
  });

  $('#btnXuatHD').addEventListener('click', async ()=>{
    if(!currentDP){ notify('Chưa có mã đặt phòng'); return; }
    const giamGia = parseFloat($('#giamGia').value || '0');
    const phuongThuc = $('#phuongThuc').value || 'TIEN_MAT';
    try{
      await API.xuatHoaDon({ maDatPhong: currentDP.maDatPhong, giamGia, phuongThuc });
      const hd = await API.hdByBooking(currentDP.maDatPhong);
      renderHD(hd);
      notify('Đã tạo hoá đơn');
    }catch(e){ notify(e); }
  });

  // ========= Init =========
  (async function init(){
    // set default dates: hôm nay & +1
    const today = new Date(); const t2 = new Date(Date.now()+86400000);
    $('#nhan').value = today.toISOString().slice(0,10);
    $('#tra').value  = t2.toISOString().slice(0,10);
    await loadDichVu();
  })();
</script>
</body>
</html>
